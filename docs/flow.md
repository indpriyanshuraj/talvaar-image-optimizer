# Code Execution Flow

> This documentation was generated by Google Gemini 2.5.

This document describes the step-by-step execution flow of the application, from launch to completion, for both CLI and Interactive modes.

## 1. Non-Interactive (CLI) Mode Flow

This flow is triggered when the application is launched with any command-line arguments (e.g., `python main.py -i ./input`).

1.  **Entry Point**: Execution begins in `main.py`.
2.  **CLI Orchestrator**: `main.py` immediately calls `resizer_module.cli.cli_mode()`.
3.  **Argument Parsing**: `cli_mode()` uses `argparse` to parse all command-line arguments (`--i`, `--o`, `--percent`, `--log`, etc.) into an `args` object.
4.  **Logging Setup**: `setup_logging(verbose=args.log)` is called. If `--log` was passed, it configures the `logging` module to write DEBUG-level information to `resizer.log`. Otherwise, it configures for INFO-level.
5.  **Input Validation**: The script checks for the input path provided by `--i` or a positional argument. If a valid path is found, it recursively scans for all image files and populates a list. If the path is invalid or no images are found, the program exits.
6.  **Pre-Analysis Report (Optional)**: If the `--report` flag was used, `run_pre_analysis()` is called *before* any processing begins. This function scans all images in parallel, gathers statistics, and prints a summary table to the console.
7.  **Processing Execution**: `run_processing()` is called with all the configuration derived from the arguments.
8.  **Parallel Worker Initialization**: `run_processing()` creates a `concurrent.futures.ProcessPoolExecutor`, which manages a pool of separate Python processes (one for each CPU core, up to a limit).
9.  **Task Submission**: The list of image files is iterated, and for each file, a task is submitted to the executor. Each task is a call to `worker.py:process_single_image`.
10. **Single Image Pipeline (in a separate process)**:
    a. `process_single_image()` receives the file path and configuration.
    b. It opens the image with `Pillow`.
    c. It determines the correct resizing algorithm (`NEAREST`/`LANCZOS`) if resizing is needed.
    d. It resizes the image.
    e. It calls `optimizer.py:smart_optimize()`.
    f. `smart_optimize()` analyzes the image, generates safe optimization candidates (`RGB`, `Palette`, etc.), and tests them in memory.
    g. The smallest resulting image buffer is returned to `process_single_image()`.
    h. `process_single_image()` writes the winning buffer to the final output file.
    i. It returns the status and size reduction details back to the main process.
11. **Progress Tracking**: As each worker process completes its task, the main process updates the `rich.progress` bar. Any errors from the worker are printed to the console.
12. **Final Report**: Once all files have been processed, `run_processing()` calculates the total size savings and prints the final summary table.

## 2. Interactive Mode Flow

This flow is triggered when the application is launched with **no** command-line arguments (`python main.py`).

1.  **Entry Point**: Execution begins in `main.py`.
2.  **CLI Orchestrator**: `main.py` calls `resizer_module.cli.cli_mode()`.
3.  **Mode Detection**: `cli_mode()` checks `sys.argv` and, seeing no arguments, immediately calls `interactive_mode()` and halts further execution in `cli_mode`.
4.  **Guided Prompts**: `interactive_mode()` proceeds to ask the user a series of questions using `rich.prompt`:
    - "Input file or folder?"
    - "Run Pre-Analysis Report?" (If yes, it runs the report and asks to continue).
    - "Output directory?"
    - "Resize Mode?"
    - and so on for all other configuration options.
5.  **Configuration Gathering**: The answers from the user are collected into the same `res_config` and `save_config` dictionaries that the CLI mode uses.
6.  **Merge with Main Flow**: Once all questions are answered, `interactive_mode()` calls `run_processing()` with the collected configuration.
7.  **Processing**: From this point forward, the execution flow is **identical to steps 8-12 of the CLI Mode Flow**. The `run_processing` function is agnostic; it doesn't care whether its configuration came from `argparse` or `rich.prompt`.
